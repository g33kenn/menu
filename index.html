<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHAT'S COOKING?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling for a better dark mode experience */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            margin: 2px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .tag-protein { background-color: #ef4444; color: white; }
        .tag-side { background-color: #f59e0b; color: white; }
        .tag-veggie { background-color: #22c55e; color: white; }
        .tag-unselected { background-color: #4b5563; color: #d1d5db; }
        .tag-remove {
            margin-left: 8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
        }
        .autocomplete-active {
            background-color: #374151; /* A slightly lighter gray for highlight */
            color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-gray-800 rounded-lg shadow-xl">
            <h1 class="text-3xl font-bold mb-4 text-white">WHAT'S COOKING? üçú</h1>
            <p class="text-gray-400 mb-6">Sign in to manage your personal dish database.</p>
            <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mx-auto">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 3.02-2.31 5.45-4.92 7.18l7.98 6.19c4.63-4.28 7.3-10.39 7.3-17.33z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.98-6.19c-2.11 1.45-4.8 2.3-7.91 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main App View -->
    <div id="app-view" class="hidden h-screen flex flex-col">
        <header class="bg-gray-800 shadow-md p-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">WHAT'S COOKING? üçú</h1>
            <div class="flex items-center">
                 <div id="user-info" class="text-sm text-gray-400 mr-4"></div>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Logout</button>
            </div>
        </header>
        
        <nav class="bg-gray-800 border-t border-b border-gray-700">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex items-center justify-center h-16">
                    <button id="btn-menu" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Menu</button>
                    <button id="btn-database" class="ml-4 text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Database</button>
                </div>
            </div>
        </nav>

        <main class="flex-grow p-4 md:p-6 overflow-y-auto">
            <!-- Database Page -->
            <div id="page-database">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Dish Creation Form -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 id="form-title" class="text-2xl font-bold mb-4 text-white">Create New Dish</h2>
                        <form id="dish-form">
                            <input type="hidden" id="dish-id">
                            <div class="mb-4">
                                <label for="dish-name" class="block text-sm font-medium text-gray-300 mb-1">Dish Name</label>
                                <input type="text" id="dish-name" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <!-- Ingredient Inputs -->
                            <div class="mb-4 relative">
                                <label for="protein-input" class="block text-sm font-medium text-gray-300 mb-1">Protein (press Enter to add)</label>
                                <input type="text" id="protein-input" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500" autocomplete="off">
                                <div id="protein-autocomplete" class="absolute z-10 w-full bg-gray-600 rounded-b-md shadow-lg hidden"></div>
                                <div id="protein-tags" class="mt-2"></div>
                            </div>
                            <div class="mb-4 relative">
                                <label for="side-input" class="block text-sm font-medium text-gray-300 mb-1">Side (press Enter to add)</label>
                                <input type="text" id="side-input" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500" autocomplete="off">
                                <div id="side-autocomplete" class="absolute z-10 w-full bg-gray-600 rounded-b-md shadow-lg hidden"></div>
                                <div id="side-tags" class="mt-2"></div>
                            </div>
                            <div class="mb-4 relative">
                                <label for="veggie-input" class="block text-sm font-medium text-gray-300 mb-1">Veggie (press Enter to add)</label>
                                <input type="text" id="veggie-input" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500" autocomplete="off">
                                <div id="veggie-autocomplete" class="absolute z-10 w-full bg-gray-600 rounded-b-md shadow-lg hidden"></div>
                                <div id="veggie-tags" class="mt-2"></div>
                            </div>
                            <div class="flex space-x-2">
                                <button type="submit" id="save-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save Dish</button>
                                <button type="button" id="clear-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Clear</button>
                            </div>
                        </form>
                    </div>

                    <!-- Existing Dishes List -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 text-white">Your Dishes</h2>
                        <div id="dishes-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                            <!-- Dish items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu Page -->
            <div id="page-menu" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Ingredient Filters -->
                    <div class="md:col-span-1 lg:col-span-1 bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 text-white">Ingredients üìã</h2>
                        <div>
                            <h3 class="text-lg font-semibold mt-4 mb-2 text-red-400">Proteins</h3>
                            <div id="menu-filters-protein" class="flex flex-wrap gap-2"></div>
                            <h3 class="text-lg font-semibold mt-4 mb-2 text-yellow-400">Sides</h3>
                            <div id="menu-filters-side" class="flex flex-wrap gap-2"></div>
                            <h3 class="text-lg font-semibold mt-4 mb-2 text-green-400">Veggies</h3>
                            <div id="menu-filters-veggie" class="flex flex-wrap gap-2"></div>
                            <button id="reset-filters-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-md">Reset</button>
                        </div>
                    </div>
                    <!-- Filtered Dishes -->
                    <div class="md:col-span-2 lg:col-span-3 bg-gray-800 p-6 rounded-lg shadow-lg">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-white">You can cook üçõ</h2>
                            <div id="dish-count" class="text-sm text-gray-400"></div>
                        </div>
                        <div id="menu-dishes-list" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                           <!-- Filtered dishes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // IMPORTANT: Replace the following with your app's Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDMwXx_1o5QOS2nva0Y4Fe__2O42C9ct1E",
            authDomain: "cha-menu-8b678.firebaseapp.com",
            projectId: "cha-menu-8b678",
            storageBucket: "cha-menu-8b678.firebasestorage.app",
            messagingSenderId: "295684256764",
            appId: "1:295684256764:web:774ad59fd48e454cccb879"
        };

        // Import functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc,
            deleteDoc,
            onSnapshot,
            query,
            getDoc,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- App State ---
        let currentUser = null;
        let dishes = [];
        let allIngredients = { protein: [], side: [], veggie: [] };
        let selectedMenuFilters = [];

        // --- UI Elements ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        
        const btnDatabase = document.getElementById('btn-database');
        const btnMenu = document.getElementById('btn-menu');
        const pageDatabase = document.getElementById('page-database');
        const pageMenu = document.getElementById('page-menu');

        const dishForm = document.getElementById('dish-form');
        const formTitle = document.getElementById('form-title');
        const dishIdInput = document.getElementById('dish-id');
        const dishNameInput = document.getElementById('dish-name');
        const saveBtn = document.getElementById('save-btn');
        const clearBtn = document.getElementById('clear-btn');
        
        const dishesListContainer = document.getElementById('dishes-list');
        const menuDishesListContainer = document.getElementById('menu-dishes-list');
        const dishCount = document.getElementById('dish-count');

        const ingredientInputs = {
            protein: document.getElementById('protein-input'),
            side: document.getElementById('side-input'),
            veggie: document.getElementById('veggie-input')
        };
        const tagContainers = {
            protein: document.getElementById('protein-tags'),
            side: document.getElementById('side-tags'),
            veggie: document.getElementById('veggie-tags')
        };
        const autocompleteContainers = {
             protein: document.getElementById('protein-autocomplete'),
             side: document.getElementById('side-autocomplete'),
             veggie: document.getElementById('veggie-autocomplete')
        };
        const menuFilterContainers = {
            protein: document.getElementById('menu-filters-protein'),
            side: document.getElementById('menu-filters-side'),
            veggie: document.getElementById('menu-filters-veggie')
        };
        const resetFiltersBtn = document.getElementById('reset-filters-btn');
        
        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
                userInfo.textContent = `Welcome, ${user.displayName.split(' ')[0]}!`;
                initializeAppState();
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                appView.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- App Initialization ---
        function initializeAppState() {
            if (!currentUser) return;
            // Listen for real-time updates on dishes
            const dishesCollection = collection(db, 'users', currentUser.uid, 'dishes');
            onSnapshot(query(dishesCollection), (snapshot) => {
                dishes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort dishes alphabetically by name
                dishes.sort((a, b) => a.name.localeCompare(b.name));
                updateAllIngredientsFromDishes(dishes);
                renderDishesLists();
                filterAndRenderMenuDishes();
            });
            
            // Listen for real-time updates on ingredients
            const ingredientsDoc = doc(db, 'users', currentUser.uid, 'ingredients', 'all');
            onSnapshot(ingredientsDoc, (doc) => {
                if(doc.exists()) {
                    allIngredients = doc.data();
                } else {
                    allIngredients = { protein: [], side: [], veggie: [] };
                }
                renderMenuFilters();
            });
        }
        
        // --- Page Navigation ---
        function showPage(pageName) {
            pageDatabase.classList.toggle('hidden', pageName !== 'database');
            pageMenu.classList.toggle('hidden', pageName !== 'menu');
            btnDatabase.classList.toggle('bg-gray-900', pageName === 'database');
            btnMenu.classList.toggle('bg-gray-900', pageName === 'menu');
        }
        btnDatabase.addEventListener('click', () => showPage('database'));
        btnMenu.addEventListener('click', () => showPage('menu'));
        showPage('menu'); // Default page


        // --- Rendering Functions ---
        function renderTag(text, category, container, isRemovable = true) {
            const tag = document.createElement('div');
            tag.textContent = text;
            tag.className = `tag tag-${category}`;
            if (isRemovable) {
                tag.dataset.value = text;
                const removeBtn = document.createElement('span');
                removeBtn.textContent = 'x';
                removeBtn.className = 'tag-remove';
                removeBtn.onclick = () => tag.remove();
                tag.appendChild(removeBtn);
            }
            container.appendChild(tag);
        }

        function renderDishesLists() {
            renderDatabaseDishList();
            filterAndRenderMenuDishes();
        }

        function renderDatabaseDishList() {
            dishesListContainer.innerHTML = '';
             if (dishes.length === 0) {
                dishesListContainer.innerHTML = `<p class="text-gray-400">No dishes created yet. Add one to get started!</p>`;
                return;
            }
            dishes.forEach(dish => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-start';
                div.innerHTML = `
                    <div>
                        <h4 class="font-bold text-lg text-white">${dish.name}</h4>
                        <div class="flex flex-wrap mt-2">
                            ${dish.protein.map(p => `<span class="tag tag-protein">${p}</span>`).join('')}
                            ${dish.side.map(s => `<span class="tag tag-side">${s}</span>`).join('')}
                            ${dish.veggie.map(v => `<span class="tag tag-veggie">${v}</span>`).join('')}
                        </div>
                    </div>
                    <div class="flex-shrink-0 ml-4">
                        <button class="edit-btn text-blue-400 hover:text-blue-300 mr-2" data-id="${dish.id}">Edit</button>
                        <button class="delete-btn text-red-400 hover:text-red-300" data-id="${dish.id}">Delete</button>
                    </div>
                `;
                dishesListContainer.appendChild(div);
            });
        }
        
        function renderMenuFilters() {
            Object.keys(menuFilterContainers).forEach(category => {
                const container = menuFilterContainers[category];
                container.innerHTML = '';
                const ingredients = allIngredients[category] || [];
                ingredients.sort().forEach(ingredient => {
                    const tag = document.createElement('div');
                    tag.textContent = ingredient;
                    const isSelected = selectedMenuFilters.includes(ingredient);
                    tag.className = `tag hover:opacity-100 transition-opacity`;
                    if (isSelected) {
                        tag.classList.add(`tag-${category}`);
                    } else {
                        tag.classList.add('tag-unselected');
                    }
                    tag.dataset.ingredient = ingredient;
                    tag.dataset.category = category;
                    tag.addEventListener('click', handleMenuFilterClick);
                    container.appendChild(tag);
                });
            });
        }

        function filterAndRenderMenuDishes() {
            let filteredDishes = dishes;
            if (selectedMenuFilters.length > 0) {
                filteredDishes = dishes.filter(dish => {
                    const dishIngredients = [...dish.protein, ...dish.side, ...dish.veggie];
                    return selectedMenuFilters.every(filter => dishIngredients.includes(filter));
                });
            }
            menuDishesListContainer.innerHTML = '';
            dishCount.textContent = `${filteredDishes.length} of ${dishes.length} dishes shown`;

            if (filteredDishes.length === 0) {
                menuDishesListContainer.innerHTML = `<p class="text-gray-400">No dishes match your selected ingredients.</p>`;
                return;
            }
            
            filteredDishes.forEach(dish => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-4 rounded-lg';
                 const getDishIngredientTag = (ingredient, category) => {
                    const isSelected = selectedMenuFilters.includes(ingredient);
                    const colorClass = isSelected ? `tag-${category}` : 'tag-unselected';
                    return `<span class="tag ${colorClass}">${ingredient}</span>`;
                };

                div.innerHTML = `
                    <h4 class="font-bold text-lg text-white">${dish.name}</h4>
                    <div class="flex flex-wrap mt-2">
                        ${dish.protein.map(p => getDishIngredientTag(p, 'protein')).join('')}
                        ${dish.side.map(s => getDishIngredientTag(s, 'side')).join('')}
                        ${dish.veggie.map(v => getDishIngredientTag(v, 'veggie')).join('')}
                    </div>
                `;
                menuDishesListContainer.appendChild(div);
            });
        }

        // --- Event Handlers ---
        // Handle adding ingredient tags
        Object.keys(ingredientInputs).forEach(category => {
            const input = ingredientInputs[category];
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = input.value.trim().toLowerCase();
                    if (value) {
                        const existingTags = Array.from(tagContainers[category].children).map(t => t.dataset.value);
                        if (!existingTags.includes(value)) {
                            renderTag(value, category, tagContainers[category]);
                        }
                        input.value = '';
                        hideAutocomplete(category);
                    }
                }
            });
        });
        
        // Handle form submission
        dishForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const dishData = {
                name: dishNameInput.value.trim(),
                protein: Array.from(tagContainers.protein.children).map(t => t.dataset.value),
                side: Array.from(tagContainers.side.children).map(t => t.dataset.value),
                veggie: Array.from(tagContainers.veggie.children).map(t => t.dataset.value)
            };
            
            if (!dishData.name) {
                alert("Please enter a dish name.");
                return;
            }

            const id = dishIdInput.value;
            const dishesCollection = collection(db, 'users', currentUser.uid, 'dishes');

            try {
                if (id) { // Update existing dish
                    await setDoc(doc(dishesCollection, id), dishData);
                } else { // Create new dish
                    await addDoc(dishesCollection, dishData);
                }
                
                clearForm();

            } catch (error) {
                console.error("Error saving dish: ", error);
                alert("There was an error saving your dish.");
            }
        });
        
        // Handle edit and delete buttons
        dishesListContainer.addEventListener('click', (e) => {
            const target = e.target;
            const id = target.dataset.id;
            if (id && target.classList.contains('edit-btn')) {
                const dish = dishes.find(d => d.id === id);
                if (dish) {
                    formTitle.textContent = "Edit Dish";
                    dishIdInput.value = dish.id;
                    dishNameInput.value = dish.name;
                    saveBtn.textContent = "Update Dish";
                    
                    Object.keys(tagContainers).forEach(category => {
                        tagContainers[category].innerHTML = '';
                        dish[category].forEach(item => renderTag(item, category, tagContainers[category]));
                    });
                }
            } else if (id && target.classList.contains('delete-btn')) {
                if (confirm("Are you sure you want to delete this dish?")) {
                    deleteDoc(doc(db, 'users', currentUser.uid, 'dishes', id));
                }
            }
        });
        
        // Clear form
        clearBtn.addEventListener('click', clearForm);
        function clearForm() {
            dishForm.reset();
            dishIdInput.value = '';
            formTitle.textContent = "Create New Dish";
            saveBtn.textContent = "Save Dish";
            Object.values(tagContainers).forEach(container => container.innerHTML = '');
        }
        
        // Autocomplete logic
        let autocompleteFocus = -1;

        Object.keys(ingredientInputs).forEach(category => {
            const input = ingredientInputs[category];
            const autocompleteContainer = autocompleteContainers[category];

            input.addEventListener('input', function() {
                const value = this.value.trim().toLowerCase();
                if (value.length < 1) {
                    hideAutocomplete(category);
                    return;
                }

                const suggestions = (allIngredients[category] || [])
                    .filter(ing => ing.toLowerCase().startsWith(value))
                    .slice(0, 5);
                
                autocompleteFocus = -1;
                if (suggestions.length > 0) {
                    autocompleteContainer.innerHTML = suggestions.map(s => 
                        `<div class="p-2 hover:bg-gray-500 cursor-pointer" data-category="${category}" data-value="${s}">${s}</div>`
                    ).join('');
                    autocompleteContainer.classList.remove('hidden');
                } else {
                    hideAutocomplete(category);
                }
            });

            input.addEventListener('keydown', function(e) {
                let items = autocompleteContainer.getElementsByTagName('div');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    autocompleteFocus++;
                    addActive(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    autocompleteFocus--;
                    addActive(items);
                } else if (e.key === 'Enter' || e.key === 'Tab') {
                    if (autocompleteFocus > -1) {
                        e.preventDefault();
                        items[autocompleteFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    hideAutocomplete(category);
                }
            });

            autocompleteContainer.addEventListener('click', (e) => {
                if (e.target.dataset.value) {
                    const { value, category } = e.target.dataset;
                    addIngredientTag(value, category);
                    ingredientInputs[category].value = '';
                    hideAutocomplete(category);
                }
            });
        });

        function addIngredientTag(value, category) {
            const existingTags = Array.from(tagContainers[category].children).map(t => t.dataset.value);
            if (!existingTags.includes(value)) {
                renderTag(value, category, tagContainers[category]);
            }
        }
        
        function addActive(items) {
            if (!items || items.length === 0) return false;
            removeActive(items);
            if (autocompleteFocus >= items.length) autocompleteFocus = 0;
            if (autocompleteFocus < 0) autocompleteFocus = (items.length - 1);
            items[autocompleteFocus].classList.add("autocomplete-active");
        }

        function removeActive(items) {
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove("autocomplete-active");
            }
        }

        function hideAutocomplete(category) {
            if (autocompleteContainers[category]) {
                autocompleteContainers[category].classList.add('hidden');
            }
        }

        document.addEventListener('click', (e) => {
            Object.keys(autocompleteContainers).forEach(category => {
                if (!ingredientInputs[category].contains(e.target) && !autocompleteContainers[category].contains(e.target)) {
                    hideAutocomplete(category);
                }
            });
        });
        
        // Handle menu filter clicks
        function handleMenuFilterClick(e) {
            const tag = e.target;
            const ingredient = tag.dataset.ingredient;
            const category = tag.dataset.category;
            
            if (selectedMenuFilters.includes(ingredient)) {
                selectedMenuFilters = selectedMenuFilters.filter(item => item !== ingredient);
                tag.classList.remove(`tag-${category}`);
                tag.classList.add('tag-unselected');
            } else {
                selectedMenuFilters.push(ingredient);
                tag.classList.add(`tag-${category}`);
                tag.classList.remove('tag-unselected');
            }
            
            filterAndRenderMenuDishes();
        }

        resetFiltersBtn.addEventListener('click', () => {
            selectedMenuFilters = [];
            renderMenuFilters();
            filterAndRenderMenuDishes();
        });

        // --- Firestore Helper Functions ---
        async function updateAllIngredientsFromDishes(dishes) {
            if (!currentUser) return;

            const newAllIngredients = {
                protein: new Set(),
                side: new Set(),
                veggie: new Set()
            };

            dishes.forEach(dish => {
                (dish.protein || []).forEach(ing => newAllIngredients.protein.add(ing));
                (dish.side || []).forEach(ing => newAllIngredients.side.add(ing));
                (dish.veggie || []).forEach(ing => newAllIngredients.veggie.add(ing));
            });

            const ingredientsForFirestore = {
                protein: Array.from(newAllIngredients.protein).sort(),
                side: Array.from(newAllIngredients.side).sort(),
                veggie: Array.from(newAllIngredients.veggie).sort()
            };
            
            const comparableOldIngredients = {
                protein: [...(allIngredients.protein || [])].sort(),
                side: [...(allIngredients.side || [])].sort(),
                veggie: [...(allIngredients.veggie || [])].sort(),
            };

            if (JSON.stringify(ingredientsForFirestore) !== JSON.stringify(comparableOldIngredients)) {
                const ingredientsDocRef = doc(db, 'users', currentUser.uid, 'ingredients', 'all');
                await setDoc(ingredientsDocRef, ingredientsForFirestore);
            }
        }

    </script>
</body>
</html>
