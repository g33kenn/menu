<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What's Cooking?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for animations or specific overrides */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        body {
            background-color: #111827; /* dark:bg-gray-900 */
        }
    </style>
</head>
<body class="font-sans bg-gray-50 dark:bg-gray-900">

    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Your Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCIVdjx95c7v-40t0TmhqWm3467F1BAkHg",
            authDomain: "menu-cf506.firebaseapp.com",
            projectId: "menu-cf506",
            storageBucket: "menu-cf506.firebasestorage.app",
            messagingSenderId: "568101794661",
            appId: "1:568101794661:web:293d9c6cff80ea6e5d678c"
        };

        // --- Global State ---
        let appState = {
            page: 'menu', // 'database' or 'menu'
            dishes: [],
            user: null,
            loading: true,
            confirmDeleteId: null,
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'what-is-cooking-app'; // A unique ID for your app's data partition

        // --- Gemini API Call ---
        const categorizeIngredient = async (ingredientName) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [{
                        text: `Categorize this food item into one of the following exact categories: "Protein", "Side", "Fruit/Vegetable". Do not provide any other explanation or text. Ingredient: "${ingredientName}"`
                    }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "OBJECT", properties: { category: { type: "STRING", enum: ["Protein", "Side", "Fruit/Vegetable"] } } }
                }
            };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) return "Other";
                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const jsonResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                    return jsonResponse.category || "Other";
                }
                return "Other";
            } catch (error) {
                console.error('Error categorizing ingredient:', error);
                return "Other";
            }
        };

        // --- Main Render Function ---
        const root = document.getElementById('app-root');
        function render() {
            root.innerHTML = App(appState);

            // Re-attach event listeners after every render
            attachEventListeners();
        }
        
        // --- State Update Function ---
        function setState(newState) {
             appState = { ...appState, ...newState };
             render();
        }

        // --- App Component (Template Literal) ---
        const App = ({ page, user, loading }) => {
            if (loading) {
                return `
                    <div class="min-h-screen flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-xl text-gray-700 dark:text-gray-300">Loading...</span>
                    </div>
                `;
            }

            return `
                <div class="font-sans min-h-screen flex flex-col">
                    <header class="bg-white dark:bg-gray-800 shadow-md dark:border-b dark:border-gray-700 z-10">
                        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center">
                                    <span class="font-bold text-2xl text-gray-800 dark:text-white">üç≥ What's Cooking?</span>
                                </div>
                                ${ user ? `
                                    <div class="flex items-center gap-4">
                                        <div class="flex gap-2">
                                            <button data-page="menu" class="page-nav px-4 py-2 text-sm font-medium rounded-md transition-colors ${page === 'menu' ? 'bg-sky-600 text-white' : 'text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700'}">Menu</button>
                                            <button data-page="database" class="page-nav px-4 py-2 text-sm font-medium rounded-md transition-colors ${page === 'database' ? 'bg-sky-600 text-white' : 'text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700'}">Database</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <img src="${user.photoURL}" alt="${user.displayName}" class="h-8 w-8 rounded-full" />
                                            <button id="sign-out-btn" class="text-sm text-gray-600 dark:text-gray-300 hover:underline">Sign Out</button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </nav>
                    </header>
                    <main class="flex-grow">
                        ${ !user ? LoginScreen() : page === 'database' ? DatabasePage() : MenuPage() }
                    </main>
                </div>
            `;
        };

        const LoginScreen = () => `
            <div class="flex-grow flex items-center justify-center">
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">Welcome to What's Cooking?</h1>
                    <p class="text-lg text-gray-600 dark:text-gray-300 mb-8">Sign in to save your recipes.</p>
                    <button id="sign-in-btn" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-sky-600 hover:bg-sky-700">
                         <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039L38.804 9.69C34.553 5.882 29.563 3.5 24 3.5C11.735 3.5 1.5 13.735 1.5 26S11.735 48.5 24 48.5c12.265 0 22.5-9.235 22.5-22.5c0-1.56-.14-3.09-.389-4.584z"/><path fill="#FF3D00" d="M6.306 14.691c2.119-3.954 6.036-6.68 10.694-7.482V3.5C11.735 3.5 1.5 13.735 1.5 26s10.235 22.5 22.5 22.5c2.446 0 4.81-.397 7.027-1.122l-6.22-6.22c-2.31 1.458-5.044 2.342-8.007 2.342c-6.627 0-12-5.373-12-12c0-2.963 1.079-5.697 2.806-7.809z"/><path fill="#4CAF50" d="M24 48.5c5.523 0 10.513-2.006 14.389-5.389l-6.734-6.734a12.01 12.01 0 0 1-7.655 2.723c-6.627 0-12-5.373-12-12c0-3.935 1.901-7.438 4.881-9.69L6.306 14.691C3.413 18.062 1.5 22.373 1.5 27s1.913 8.938 5.194 12.309C9.487 44.094 16.273 48.5 24 48.5z"/></svg>
                        Sign In with Google
                    </button>
                </div>
            </div>
        `;
        
        // --- Database Page ---
        // For simplicity, we manage the state of the form inputs directly in the DOM
        const DatabasePage = () => {
             // ... logic for DatabasePage (add, update, delete)
            return `
                <div class="max-w-4xl mx-auto p-4 md:p-6 space-y-6">
                     ${appState.confirmDeleteId ? DeleteConfirmationModal() : ''}
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Add a New Dish</h2>
                        <input id="new-dish-name" type="text" placeholder="Dish Name (e.g., Poulet Yassa)" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-transparent dark:text-white">
                        <div id="ingredient-input-container"></div>
                        <button id="add-dish-btn" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition-colors">
                            + Add Dish to Database
                        </button>
                    </div>
                    <div class="space-y-4">
                         <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Your Dishes</h2>
                         <div id="dishes-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${appState.dishes.length > 0 ? appState.dishes.map(DishCard).join('') : '<p class="text-gray-400">No dishes yet.</p>'}
                         </div>
                    </div>
                </div>
            `;
        };

        const DishCard = (dish) => `
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md space-y-3">
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">${dish.name}</h3>
                    <div class="flex gap-2">
                        <button class="delete-dish-btn" data-id="${dish.id}">üóëÔ∏è</button>
                    </div>
                </div>
                <div>
                     <h4 class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">Ingredients:</h4>
                     <div class="flex flex-wrap gap-2">
                        ${dish.ingredients.map(ing => `<span class="px-2.5 py-1 text-sm font-medium rounded-full bg-gray-700 text-gray-300">${ing.name}</span>`).join('')}
                     </div>
                </div>
            </div>
        `;
        
         const DeleteConfirmationModal = () => `
            <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 animate-fade-in">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">Confirm Deletion</h3>
                    <p class="text-gray-600 dark:text-gray-300 mt-2 mb-4">Are you sure you want to delete this dish?</p>
                    <div class="flex justify-end gap-4">
                        <button id="cancel-delete-btn" class="px-4 py-2 rounded-md bg-gray-600 text-gray-200 hover:bg-gray-500 font-medium">Cancel</button>
                        <button id="confirm-delete-btn" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 font-medium">Delete</button>
                    </div>
                </div>
            </div>
        `;

        // --- Menu Page ---
        const MenuPage = () => {
             // ... logic for MenuPage
            return `<p class="text-white p-6">Menu Page (Content to be implemented)</p>`;
        };


        // --- Event Listeners ---
        function attachEventListeners() {
            // Auth Buttons
            const signInBtn = document.getElementById('sign-in-btn');
            if(signInBtn) signInBtn.addEventListener('click', signInWithGoogle);

            const signOutBtn = document.getElementById('sign-out-btn');
            if(signOutBtn) signOutBtn.addEventListener('click', handleSignOut);

            // Page Navigation
            document.querySelectorAll('.page-nav').forEach(btn => {
                btn.addEventListener('click', (e) => setState({ page: e.target.dataset.page }));
            });
            
            // Database Page specific listeners
            if(appState.page === 'database'){
                const addDishBtn = document.getElementById('add-dish-btn');
                if(addDishBtn) addDishBtn.addEventListener('click', handleAddDish);
                
                document.querySelectorAll('.delete-dish-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        setState({ confirmDeleteId: id });
                    });
                });

                const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
                if(confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', handleConfirmDelete);

                const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
                if(cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => setState({ confirmDeleteId: null }));
            }
        }
        
        // --- Firebase Logic Handlers ---
        
        async function handleAddDish() {
            const newDishName = document.getElementById('new-dish-name').value;
            if (!newDishName.trim() || !appState.user) return;
            
            // Note: Ingredient logic would need to be re-implemented here
            const newDish = { name: newDishName, ingredients: [], createdAt: serverTimestamp() };
            
            try {
                const collectionPath = `/artifacts/${appId}/users/${appState.user.uid}/dishes`;
                await addDoc(collection(db, collectionPath), newDish);
                document.getElementById('new-dish-name').value = ''; // Clear input
            } catch(e) {
                console.error("Error adding document: ", e);
            }
        }
        
        async function handleConfirmDelete() {
            if(!appState.confirmDeleteId || !appState.user) return;
            try {
                const dishDocRef = doc(db, `/artifacts/${appId}/users/${appState.user.uid}/dishes`, appState.confirmDeleteId);
                await deleteDoc(dishDocRef);
                setState({ confirmDeleteId: null });
            } catch(e) {
                 console.error("Error deleting document: ", e);
            }
        }


        const signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Authentication error:", error);
            }
        };

        const handleSignOut = () => signOut(auth);

        // --- Auth State and Data Listener ---
        onAuthStateChanged(auth, (currentUser) => {
            setState({ user: currentUser, loading: false });

            if (currentUser) {
                // User is signed in, listen for their data
                const collectionPath = `/artifacts/${appId}/users/${currentUser.uid}/dishes`;
                const q = query(collection(db, collectionPath));
                
                onSnapshot(q, (querySnapshot) => {
                    const dishesData = [];
                    querySnapshot.forEach((doc) => {
                        dishesData.push({ id: doc.id, ...doc.data() });
                    });
                    dishesData.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0) );
                    setState({ dishes: dishesData });
                }, (error) => {
                    console.error("Error fetching dishes:", error);
                });
            } else {
                // User is signed out
                setState({ dishes: [] });
            }
        });

        // --- Initial Render ---
        render();

    </script>
</body>
</html>
